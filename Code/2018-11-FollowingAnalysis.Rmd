---
title: "Following analysis"
output: html_document
---


Getting individuals for homogeneous pops

```{r homogenous pops}
h_group <- rep(NA, length(common_ids$ID))
for( i in 1:6){
  h_group[adk6[,i] > 0.7] <- i 
}
summary(as.factor(h_group))
```

We'll use only pops 1, 2, 5, and 6, because of the small sample sizes in the other 2. 
Let's us see some summaries first

```{r}
#Getting subset of whole sample from groups 1, 2, 5, and 6
h_comparison <- bind_cols(as.tibble(h_group), tot_samples)
h_comparison$value[ h_comparison$value == 3 | h_comparison$value == 4] <- NA
h_comparison <- na.omit(h_comparison)

#Summaries by Sex x Pop
h_comparison %>% select(value, Sex, Age, Height, Weight, BMI) %>% group_by(Sex, value) %>%
  summarise_all(funs(mean))

#Stat tests
#Age
h_age_test <- lm(Age ~ Sex * as.factor(value), data = h_comparison)
anova(h_age_test)

#Height
h_height_test <- lm(Height ~ Sex * as.factor(value), data = h_comparison)
anova(h_height_test)

#Weight
h_weight_test <- lm(Weight ~ Sex * as.factor(value), data = h_comparison)
anova(h_weight_test)

#BMI
h_bmi_test <- lm(BMI ~ Sex * as.factor(value), data = h_comparison)
anova(h_bmi_test)
```


```{r h pop comparison}
#Getting response and predictor matrices
matrix <- h_comparison %>% select(starts_with("PC"))
covs   <- h_comparison %>% select(c("Age", "Height", "BMI","Sex", "value"))
covs[,c(1:3)] <- scale(covs[,c(1:3)])

#Getting model matrix, and runnning vector change
model_mat  <- model.matrix( ~ Age + Height + BMI + Sex * as.factor(value), data=covs)
nonallo_covs_mat <- model_mat[,1:4]
total_covs_mat   <- model_mat[,c(1:2,4)]
x_mat_red  <- model_mat[,5:8]
x_mat_full <- model_mat[,5:11]
nonallo_out_mat <- run_vector_change(matrix, nonallo_covs_mat, x_mat_red, x_mat_full, permute=9999)
total_out_mat   <- run_vector_change(matrix, total_covs_mat, x_mat_red, x_mat_full, permute=9999)

#Printing pairwise tables
nonallo_angle_table <- pairwise_pvals(nonallo_out_mat)
pvals <- nonallo_angle_table[upper.tri(nonallo_angle_table)]
print("Non allometric angles")
nonallo_angle_table
cat("\n")
nonallo_diff_table  <- pairwise_pvals(nonallo_out_mat, 0)
print("Non allometric magnitues")
nonallo_diff_table
cat("\n")

total_angle_table <- pairwise_pvals(total_out_mat)
pvals <- c(pvals, total_angle_table[upper.tri(total_angle_table)])
print("Total angles")
total_angle_table
cat("\n")
total_diff_table  <- pairwise_pvals(total_out_mat, 0)
print("Total magnitudes")
total_diff_table
```

Generate sex vectors

```{r h sex vectors}
#Get sex vectors, transform to sex landmarks, and save file
sex_vectors_nonallo <- get_sex_vectors(matrix, nonallo_covs_mat, x_mat_full)
sex_vectors_total   <- get_sex_vectors(matrix, total_covs_mat, x_mat_full)
sex_landmarks_nonallo <- t( apply( ( as.matrix(sex_vectors_nonallo[,1:70] * 1) %*% t(eigenvectors) ), 1, 
                                function(x) x + t(means) ) )
sex_landmarks_total <- t( apply( ( as.matrix(sex_vectors_total[,1:70] * 1) %*% t(eigenvectors) ), 1, 
                                function(x) x + t(means) ) )
sex_landmarks_groups <- sex_vectors_total[,71:73]
setwd(paste(path, "/Results/Vectors", sep = ""))
write.csv(sex_landmarks_nonallo, "sex_landmarks_nonallo.csv", row.names = F)
write.csv(sex_landmarks_total, "sex_landmarks_total.csv", row.names = F)
write.csv(sex_landmarks_groups, "sex_landmarks_groups.csv", row.names = F)
```

Dividing our entire sample

```{r}
#Create grouping variable t_group, containg the cluster that each individuals has more of their ancestry from
t_group <- apply(adk6, 1, function(x) which.max(x))
summary(as.factor(t_group))
```

```{r t pop comparison}
#Getting subset of whole sample from groups 
t_comparison <- bind_cols(as.tibble(t_group), tot_samples)
t_comparison <- na.omit(t_comparison)
t_comparison <- t_comparison %>% filter(Sex == "Female" | Sex == "Male") %>% mutate(value = as.factor(value))

#Getting response and predictor matrices
matrix <- t_comparison %>% select(starts_with("PC"))
covs   <- t_comparison %>% select(c("Age", "Height", "BMI","Sex", "value"))
covs[,c(1:3)] <- scale(covs[,c(1:3)])

#Getting model matrix, and runnning vector change
model_mat  <- model.matrix( ~ Age + Height + BMI + Sex * value, data=covs)
nonallo_covs_mat <- model_mat[,1:4]
total_covs_mat   <- model_mat[,c(1:2,4)]
x_mat_red  <- model_mat[,5:10]
x_mat_full <- model_mat[,5:15]
nonallo_out_mat <- run_vector_change(matrix, nonallo_covs_mat, x_mat_red, x_mat_full, permute=9999)
total_out_mat   <- run_vector_change(matrix, total_covs_mat, x_mat_red, x_mat_full, permute=9999)

#Printing pairwise tables
nonallo_angle_table <- pairwise_pvals(nonallo_out_mat)
pvals <- c(pvals, nonallo_angle_table[upper.tri(nonallo_angle_table)])
print("Non allometric angles")
nonallo_angle_table
cat("\n")
nonallo_diff_table  <- pairwise_pvals(nonallo_out_mat, 0)
print("Non allometric magnitues")
nonallo_diff_table
cat("\n")

total_angle_table <- pairwise_pvals(total_out_mat)
pvals <- c(pvals, total_angle_table[upper.tri(total_angle_table)])
print("Total angles")
total_angle_table
cat("\n")
total_diff_table  <- pairwise_pvals(total_out_mat, 0)
print("Total magnitudes")
total_diff_table

```

Effect of ancestry.
We'll create bins in ranges of 0.23 proportion of African ancestry, starting from 0.3

```{r}
af_group <- rep(NA, length(common_ids$ID))
start    <- 0.3
end      <- 0.3 + 0.23
for(i in 2:4){
  keep <- t_group == 2 & adk6$X2 > start & adk6$X2 < end
  af_group[keep] <- i
  start <- end
  end   <- end + 0.23
}
#The group number 1 will be of individuals with european ancestry from h_group
af_group[h_group == 6] <- 1

summary(as.factor(af_group))
```

```{r t pop comparison}
#Getting subset of whole sample from groups 
af_comparison <- bind_cols(as.tibble(af_group), tot_samples)
af_comparison <- na.omit(af_comparison)
af_comparison <- af_comparison %>% filter(Sex == "Female" | Sex == "Male") %>% mutate(value = as.factor(value))

#Getting response and predictor matrices
matrix <- af_comparison %>% select(starts_with("PC"))
covs   <- af_comparison %>% select(c("Age", "Height", "BMI","Sex", "value"))
covs[,c(1:3)] <- scale(covs[,c(1:3)])

#Getting model matrix, and runnning vector change
model_mat  <- model.matrix( ~ Age + Height + BMI + Sex * value, data=covs)
nonallo_covs_mat <- model_mat[,1:4]
total_covs_mat   <- model_mat[,c(1:2,4)]
x_mat_red  <- model_mat[,5:8]
x_mat_full <- model_mat[,5:11]
nonallo_out_mat <- run_vector_change(matrix, nonallo_covs_mat, x_mat_red, x_mat_full, permute=9999)
total_out_mat   <- run_vector_change(matrix, total_covs_mat, x_mat_red, x_mat_full, permute=9999)

#Printing pairwise tables
nonallo_angle_table <- pairwise_pvals(nonallo_out_mat)
pvals <- c(pvals, nonallo_angle_table[upper.tri(nonallo_angle_table)])
print("Non allometric angles")
nonallo_angle_table
cat("\n")

total_angle_table <- pairwise_pvals(total_out_mat)
pvals <- c(pvals, total_angle_table[upper.tri(total_angle_table)])
print("Total angles")
total_angle_table

```

Getting adjusted pvalues

```{r}
adjust_pval <- p.adjust(pvals, method = "fdr")
```


Getting vectors for total, allometric, and non-allometric components

```{r}
####REGRESSION MODELS AND VECTOR####
matrix  <- dplyr::select(MergedDat, starts_with("FacePC"))
covs    <- MergedDat %>% dplyr::select(c("Age", "Height", "BMI","Sex", "k6")) #add all columns with ks "k2", "k3", etc
matrix_covs <- na.omit(cbind(matrix, covs))
matrix_covs[,c(36:38)] <- scale(matrix_covs[,c(36:38)]) #Scaling data Age, Height and BMI

sex_vectors_all <- NULL
for (i in 6){ #for i in all clusters, in this case only one 6
  ks <- paste("k", i, sep="") # Creating k string
  print(ks)
  model_mat <- model.matrix( ~ Age + Height + BMI + Sex * get(ks), data=matrix_covs) #Creating design matrix
  y_mat     <- matrix_covs[,1:35] # Y matrix
  covs_mat       <- model_mat[,1:4] # Covariate matrix
  covs_mat_total <- model_mat[,c(1,2,4)] # Covariate without height
  x_mat_full <- model_mat[,5: (3+(i*2)) ] # Full model
  x_mat_red  <- model_mat[,5:(4+i)] # Reduced model
  #Vector change tests
  out_mat       <- run_vector_change(y_mat, covs_mat, x_mat_red, x_mat_full) # Vector change test for non-allometric
  out_mat_total <- run_vector_change(y_mat, covs_mat_total, x_mat_red, x_mat_full) # Vector change test for total
  assign(paste("out_mat_", ks, sep = ""), out_mat)
  assign(paste("out_mat_total_", ks, sep = ""), out_mat_total)
  #Angle and diff p-value tables
  angle_table <- pairwise_pvals(out_mat)
  diff_table  <- pairwise_pvals(out_mat, 0)
  angle_table_total <- pairwise_pvals(out_mat_total)
  diff_table_total  <- pairwise_pvals(out_mat_total, 0)
  assign(paste("angle_pvals_", ks, sep = ""), angle_table)
  assign(paste("diff_pvals_", ks, sep = ""), diff_table)
  assign(paste("angle_pvals_total_", ks, sep = ""), angle_table_total)
  assign(paste("diff_pvals_total_", ks, sep = ""), diff_table_total)
  #Sex vectors
  sex_vectors <- get_sex_vectors(y_mat, covs_mat, x_mat_full)
  sex_vectors_all <- rbind(sex_vectors_all, sex_vectors)
}
```

Adjusting p-values

```{r pvalues}
pvals_list <- mget(ls(pattern = "pvals_k"))
pvals      <- unlist(lapply(pvals_list, function(x) x[lower.tri(x)]))
adjusted_pvals <- p.adjust(pvals, method = "BH")

pvals_adjusted_list <- pvals_list
start = 1
end   = 0
for (i in 1:length(pvals_adjusted_list)){
  n_vals <- length(pvals_adjusted_list[[i]][lower.tri(pvals_adjusted_list[[i]])])
  end = end + n_vals
  pvals_adjusted_list[[i]][lower.tri(pvals_adjusted_list[[i]]) ] <- adjusted_pvals[start:end]
  start = start + n_vals
}

pvals_total_list <- mget(ls(pattern = "pvals_total_k"))
pvals            <- unlist(lapply(pvals_total_list, function(x) x[lower.tri(x)]))
adjusted_pvals   <- p.adjust(pvals, method = "BH")
pvals_adjusted_total_list <- pvals_total_list
start = 1
end   = 0
for (i in 1:length(pvals_adjusted_total_list)){
  n_vals <- length(pvals_adjusted_total_list[[i]][lower.tri(pvals_adjusted_total_list[[i]])])
  end = end + n_vals
  pvals_adjusted_total_list[[i]][lower.tri(pvals_adjusted_total_list[[i]]) ] <- adjusted_pvals[start:end]
  start = start + n_vals
}
```

Saving databases

```{r save}
setwd(paste(path, "/Results/Vectors", sep = ""))
write.csv(sex_vectors_all, "sex_vectors.csv", row.names = F)
save(pvals_adjusted_list, pvals_adjusted_total_list, file = "Pvals.RData")
```
